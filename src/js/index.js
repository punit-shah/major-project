import $ from 'jquery';
import clm from './lib/clmtrackr/clmtrackr';
import pModel from './lib/clmtrackr/models/model_pca_20_svm';
import FaceDeformer from './lib/clmtrackr/js/face_deformer';

const tracker = new clm.tracker();
tracker.init(pModel);

const $video = $('#video');

$video.on('canplay', (e) => {
  startVideo(e.target);
});

const $gridCanvas = $('#grid');
const gridContext = $gridCanvas[0].getContext('2d');

const $maskCanvas = $('#mask');

function setDimensionAttributes($element, width, height) {
  $element.attr('width', width);
  $element.attr('height', height);
}

function setVideoSize() {
  const width = $video.parent().width();
  const height = width / 4 * 3;
  setDimensionAttributes($video, width, height);
  setDimensionAttributes($gridCanvas, width, height);
  setDimensionAttributes($maskCanvas, width, height);
}

setVideoSize();
$(window).resize(setVideoSize);

const fd = new FaceDeformer();
fd.init($maskCanvas[0]);

navigator.mediaDevices.getUserMedia({
  audio: false,
  video: true,
}).then((mediaStream) => {
  $video[0].srcObject = mediaStream;
});

function startVideo(video) {
  video.play();
  tracker.start(video);
  drawModel();
}

function clearGrid() {
  gridContext.clearRect(0, 0, $gridCanvas[0].width, $gridCanvas[0].height);
}

function drawModel() {
  clearGrid();
  tracker.draw($gridCanvas[0], tracker.getCurrentParameters(), 'vertices');

  const convergence = tracker.getConvergence();
  if (convergence < 0.4) {
    loadMask();
    requestAnimationFrame(drawMask);
  } else {
    requestAnimationFrame(drawModel);
  }
}

function loadMask() {
  clearGrid();
  var maskPoints = [[63.88655053692872,176.14655644739332],[60.582536326847546,206.15582314836885],[63.7204697910491,236.82393647457275],[70.07376976270633,268.7094211205058],[83.02747395566308,295.75945920697677],[101.7768336231455,317.35551714893677],[124.49916883263116,333.58848018983394],[151.13779681754937,338.7050856142323],[177.78857807430444,333.6236639092124],[200.55125057786196,317.40846158934903],[219.29612366759164,295.82128010139235],[232.273881867677,268.79260111603105],[238.73070232234855,236.9222401745777],[241.92494946849237,206.25584306950384],[238.81589937080366,176.27302217157745],[222.17037392987788,165.1269661620851],[208.28278108245325,158.7187689422736],[186.89110938817765,159.65418868044623],[170.40889875473675,163.07482889158177],[80.90948536609362,164.79931320459582],[94.76069034903085,158.5797791762719],[116.02425468375773,159.5718339934766],[132.47082741625434,163.02096039504042],[92.75200691513757,183.71541994675027],[108.97001344998762,176.97293889998247],[126.97519806816244,183.26924112847558],[109.06630785351561,187.95803120653554],[109.449961546292,181.97614791880093],[209.77052026377459,183.81096003370862],[193.44433568886717,177.05248159529611],[175.55299300563382,183.33271065395365],[193.37882161178243,188.025411671344],[192.82234524172122,182.04956587143957],[151.41511713736764,177.51812456269988],[132.2665247305118,215.26865373916945],[125.67228879355855,228.89986232312776],[132.55501581925319,238.26441438523574],[151.45049346490305,241.07281817018725],[170.2082987309867,238.29384812365925],[177.11056936934352,228.9454919293185],[170.5276761091432,215.29698022468736],[151.46385325135697,202.16243781372566],[138.2162629308298,232.65983879779156],[164.61442420369974,232.6776469233296],[120.65553387461486,272.5257725907994],[131.06229758577518,263.91998492348284],[142.76012034802676,260.06376388246895],[151.27012834564096,261.8819042826707],[159.80868976720802,260.0629298097849],[171.4325516327092,263.9545875054874],[181.76300086700104,272.53535927960917],[173.92498645402287,279.13480786538656],[164.28319407797335,283.17542581421395],[151.19599980007644,284.5086207912485],[138.09003413215038,283.16841051681246],[128.44755980377056,279.11533103167824],[136.1965759572012,271.54929139564734],[151.22198597644223,272.9845282788874],[166.21043273368235,271.5462548523311],[166.38937202375945,269.03847580635545],[151.26803742582672,269.03322090542304],[136.1090388272752,269.02673876791323],[151.47012219613018,226.04447651250413],[99.50832856345295,178.89999972686678],[119.21521577914196,178.35773029051396],[118.47548548374324,186.20898945283795],[100.04464996854566,186.66602086385853],[202.94519207555257,178.98735925365057],[183.22978168078373,178.43755480293075],[183.98398645486404,186.27013922426283],[202.4307282860599,186.7585600700572]];
  fd.load(document.getElementById('average'), maskPoints, pModel);
}

function drawMask() {
  var positions = tracker.getCurrentPosition();
  if (positions) {
    fd.draw(positions);
  }
  requestAnimationFrame(drawMask);
}
